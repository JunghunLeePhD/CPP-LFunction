<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>L-Function Visualizer</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="stylesheet" href="/static/css/style.css" />
        <style>
            body {
                font-family: sans-serif;
                /* Responsive container width:
       Uses 95% of the screen width, but caps it at 1200px maximum. */
                width: min(95%, 1800px);
                /* Fluid vertical margin (min 20px, max 40px) */
                margin: clamp(20px, 5vh, 40px) auto;
                /* Fluid padding inside the body */
                padding: clamp(10px, 3vw, 20px);
            }

            /* Sticky Controls */
            .controls {
                position: sticky;
                top: 0;
                z-index: 100;
                display: grid;

                /* RESPONSIVE MAGIC WITHOUT @MEDIA:
       1. auto-fit: Fits as many columns as possible.
       2. minmax: Columns are at least 200px wide.
       3. min(100%, 200px): Ensures that if screen < 200px, the column doesn't overflow.
       4. 1fr: If there's extra space, distribute it equally. */
                grid-template-columns: repeat(auto-fit, minmax(min(100%, 200px), 1fr));

                gap: clamp(10px, 2vw, 20px); /* Fluid gap */
                margin-bottom: 20px;
                background: #f8f9fa;
                border-bottom: 2px solid #ddd;
                padding: 15px;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }

            .input-group label {
                display: block;
                font-size: 0.8em;
                margin-bottom: 5px;
                font-weight: bold;
            }

            .input-group input,
            .input-group select {
                width: 100%;
                box-sizing: border-box;
                background-color: #ffffff;
                border: 1px solid #ccc;
                border-radius: 8px;
                height: 40px;
                padding: 5px 10px;
                font-size: 1rem;
                color: #333;
            }

            .input-group input:focus,
            .input-group select:focus {
                outline: none;
                border-color: #007bff;
            }

            /* Buttons */
            button {
                padding: 10px;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 1em;
            }

            .btn-run {
                /* If you use this class, make it span all available columns */
                grid-column: 1 / -1;
                background: #007bff;
            }

            .chart-container {
                margin-bottom: 40px;
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }

            h3 {
                margin-top: 0;
                color: #444;
            }

            canvas {
                /* Fluid Max Height:
       Between 300px and 600px depending on viewport height. */
                max-height: clamp(300px, 60vh, 600px);
                width: 100%;
                cursor: crosshair;
            }

            /* New Styles for Sub-Figures Grid */
            #sub-charts-grid {
                display: grid;
                /* RESPONSIVE MAGIC FOR SUB-CHARTS:
       1. Try to fit as many columns as possible.
       2. Each column must be at least 300px wide.
       3. On tiny screens (<300px), min(100%, 300px) makes it take full width. */
                grid-template-columns: repeat(auto-fill, minmax(min(100%, 500px), 1fr));
                gap: 15px;
                margin-top: 20px;
            }

            .sub-chart-card {
                background: #fff;
                border: 1px solid #ddd;
                border-radius: 8px;
                padding: 10px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }

            .sub-chart-title {
                font-size: 0.9em;
                font-weight: bold;
                text-align: center;
                color: #555;
                margin-bottom: 5px;
                padding-bottom: 5px;
                border-bottom: 1px solid #eee;
            }

            /* Spinner */
            #loading-sign {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.7);
                z-index: 9999;
            }

            .spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border: 8px solid #f3f3f3;
                border-top: 8px solid #007bff;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                0% {
                    transform: translate(-50%, -50%) rotate(0deg);
                }
                100% {
                    transform: translate(-50%, -50%) rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <h2>Dirichlet L-Function Visualizer (All Characters)</h2>

        <div class="controls">
            <div class="input-group">
                <label>Range Start (t)</label>
                <input type="number" id="start" value="0" onchange="updateCharts()" />
            </div>
            <div class="input-group">
                <label>Range End (t)</label>
                <input type="number" id="end" value="100" step="100" onchange="updateCharts()" />
            </div>
            <div class="input-group">
                <label>Modulus (q)</label>
                <input type="number" id="mod" value="7" min="1" onchange="updateCharts()" />
            </div>
        </div>

        <div class="chart-container">
            <h3>Combined View</h3>
            <canvas id="logChart"></canvas>
        </div>

        <h3 style="margin-top: 40px; border-top: 2px solid #eee; padding-top: 20px">
            Individual Character Views
        </h3>
        <div id="sub-charts-grid"></div>

        <div id="loading-sign"><div class="spinner"></div></div>
        <script>
            let chartLog = null;
            let subCharts = []; // Store instances to destroy them properly

            function getColor(index, total) {
                const hue = (index * 360) / total;
                return `hsla(${hue}, 70%, 50%, 0.8)`;
            }

            async function updateCharts() {
                const start = document.getElementById('start').value;
                const end = document.getElementById('end').value;
                const q = document.getElementById('mod').value;

                const loader = document.getElementById('loading-sign');
                if (loader) loader.style.display = 'block';

                try {
                    const response = await fetch(
                        `/dirichlet_val_t_data?start=${start}&end=${end}&q=${q}`
                    );
                    const data = await response.json();

                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    const labels = data.t.map((t) => t.toFixed(2));

                    // Prepare datasets with colors
                    const datasets = data.datasets.map((ds, index) => ({
                        label: `Chi ${ds.label}`,
                        data: ds.data,
                        borderColor: getColor(index, data.datasets.length),
                        backgroundColor: 'transparent',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        tension: 0.2,
                    }));

                    // --- 1. Render Main Chart ---
                    if (chartLog) chartLog.destroy();
                    const ctx = document.getElementById('logChart').getContext('2d');
                    chartLog = new Chart(ctx, {
                        type: 'line',
                        data: { labels: labels, datasets: datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                title: {
                                    display: true,
                                    text: `Combined: log|L(0.5+it)| for mod ${q}`,
                                },
                            },
                            scales: {
                                x: {
                                    title: { display: true, text: 't' },
                                    ticks: { maxTicksLimit: 20 },
                                },
                                y: { title: { display: true, text: 'log |L|' } },
                            },
                            animation: false,
                        },
                    });

                    // --- 2. Render Sub-Charts ---
                    const grid = document.getElementById('sub-charts-grid');

                    // Cleanup old charts
                    subCharts.forEach((c) => c.destroy());
                    subCharts = [];
                    grid.innerHTML = '';

                    // Loop through each dataset and create a small card
                    datasets.forEach((ds, index) => {
                        // Create DOM elements
                        const card = document.createElement('div');
                        card.className = 'sub-chart-card';

                        const title = document.createElement('div');
                        title.className = 'sub-chart-title';
                        title.innerText = `Character Index ${ds.label.replace('Chi ', '')}`;

                        const canvasContainer = document.createElement('div');
                        canvasContainer.style.height = '200px'; // Smaller height for sub-figures
                        canvasContainer.style.position = 'relative';

                        const canvas = document.createElement('canvas');
                        canvasContainer.appendChild(canvas);
                        card.appendChild(title);
                        card.appendChild(canvasContainer);
                        grid.appendChild(card);

                        // Create Chart Instance
                        const newChart = new Chart(canvas.getContext('2d'), {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [ds], // Only this specific dataset
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                animation: false,
                                plugins: { legend: { display: false } }, // Hide legend, title is enough
                                scales: {
                                    x: { display: false }, // Hide x-axis labels to save space
                                    y: { title: { display: true, text: 'log |L|' } },
                                },
                            },
                        });
                        subCharts.push(newChart);
                    });
                } catch (error) {
                    console.error('Error computing:', error);
                } finally {
                    if (loader) loader.style.display = 'none';
                }
            }

            document.addEventListener('DOMContentLoaded', updateCharts);
        </script>
    </body>
</html>
