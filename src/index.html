<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>L-Function Visualizer</title>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <style>
            body {
                font-family: sans-serif;
                max-width: 900px;
                margin: 20px auto;
                padding: 20px;
            }

            /* Sticky Controls */
            .controls {
                position: sticky;
                top: 0;
                z-index: 100;
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 10px;
                margin-bottom: 20px;
                background: #f8f9fa;
                border-bottom: 2px solid #ddd;
                padding: 15px;
                border-radius: 0 0 8px 8px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            }
            .input-group label {
                display: block;
                font-size: 0.8em;
                margin-bottom: 5px;
                font-weight: bold;
            }
            .input-group input,
            .input-group select {
                width: 100%;
                box-sizing: border-box;

                /* 1. Force white background (overrides default grey) */
                background-color: #ffffff;

                /* 2. Define a consistent border and radius */
                border: 1px solid #ccc; /* Light grey border */
                border-radius: 8px; /* Rounded corners like your screenshot */

                /* 3. Ensure they are the same height */
                height: 40px;
                padding: 5px 10px;

                /* 4. Match font settings */
                font-size: 1rem;
                color: #333;
            }

            .input-group input:focus,
            .input-group select:focus {
                outline: none;
                border-color: #007bff; /* Blue border when clicked */
            }

            /* Buttons */
            button {
                padding: 10px;
                color: white;
                border: none;
                cursor: pointer;
                font-size: 1em;
            }
            .btn-run {
                grid-column: span 5;
                background: #007bff;
            } /* Full width */

            .chart-container {
                margin-bottom: 40px;
                border: 1px solid #ddd;
                padding: 10px;
                border-radius: 8px;
                background: white;
            }
            h3 {
                margin-top: 0;
                color: #444;
            }
            canvas {
                max-height: 600px;
                width: 100%;
                cursor: crosshair; /* Shows you can click */
            }

            /* Spinner */
            #loading-sign {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(255, 255, 255, 0.7);
                z-index: 9999;
            }
            .spinner {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                border: 8px solid #f3f3f3;
                border-top: 8px solid #007bff;
                border-radius: 50%;
                width: 60px;
                height: 60px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% {
                    transform: translate(-50%, -50%) rotate(0deg);
                }
                100% {
                    transform: translate(-50%, -50%) rotate(360deg);
                }
            }
        </style>
    </head>
    <body>
        <h2 style="margin-top: 60px">Dirichlet L-Function Visualizer</h2>

        <div class="controls">
            <div class="input-group">
                <label>Real Part (Re s)</label>
                <input type="number" id="real" value="0.5" step="0.1" onchange="updateCharts()" />
            </div>
            <div class="input-group">
                <label>Range Start (t)</label>
                <input type="number" id="start" value="0" onchange="updateCharts()" />
            </div>
            <div class="input-group">
                <label>Range End (t)</label>
                <input type="number" id="end" value="100" step="10" onchange="updateCharts()" />
            </div>
            <div class="input-group">
                <label>Modulus (q)</label>
                <input type="number" id="mod" value="1" min="1" onchange="onModulusChange()" />
            </div>
            <div class="input-group">
                <label>Character (k)</label>
                <select id="char-select" onchange="updateCharts()">
                    <option value="1">1 (Principal)</option>
                </select>
            </div>
        </div>

        <div class="chart-container">
            <h3>Complex Part</h3>
            <canvas id="complexChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Real Part</h3>
            <canvas id="realChart"></canvas>
        </div>
        <div class="chart-container">
            <h3>Imaginary Part</h3>
            <canvas id="imagChart"></canvas>
        </div>

        <div id="loading-sign"><div class="spinner"></div></div>

        <script>
            let chartReal = null;
            let chartImag = null;
            let chartComplex = null;

            // 1. HELPER: GCD
            function gcd(a, b) {
                while (b) {
                    [a, b] = [b, a % b];
                }
                return a;
            }

            // 2. MAIN LOGIC: Handle Modulus Change
            function onModulusChange() {
                const qInput = document.getElementById('mod');
                const kSelect = document.getElementById('char-select');

                let q = parseInt(qInput.value);
                if (isNaN(q) || q < 1) {
                    q = 1;
                    qInput.value = 1;
                }

                // Save current selection to restore it if possible
                const currentK = parseInt(kSelect.value) || 1;

                // Clear and Rebuild Dropdown
                kSelect.innerHTML = '';

                for (let k = 1; k <= q; k++) {
                    if (gcd(k, q) === 1) {
                        const option = document.createElement('option');
                        option.value = k;

                        if (k === 1) option.text = `${k} (Principal)`;
                        else if (k === q - 1 && q > 2) option.text = `${k}`;
                        else option.text = k;

                        kSelect.appendChild(option);
                    }
                }

                // Restore previous selection if it is still valid for the new q
                let exists = false;
                for (let opt of kSelect.options) {
                    if (parseInt(opt.value) === currentK) {
                        kSelect.value = currentK;
                        exists = true;
                        break;
                    }
                }
                if (!exists) kSelect.value = 1;

                // Finally, update the charts
                updateCharts();
            }

            // 3. CHART & ZOOM FUNCTIONS
            function zoomTo(centerT) {
                const startInput = document.getElementById('start');
                const endInput = document.getElementById('end');
                const currentRange = parseFloat(endInput.value) - parseFloat(startInput.value);
                const newRange = currentRange / 4;
                const newStart = centerT - newRange / 2;
                const newEnd = centerT + newRange / 2;
                startInput.value = newStart.toFixed(4);
                endInput.value = newEnd.toFixed(4);
                updateCharts();
            }

            function resetZoom() {
                document.getElementById('start').value = '0';
                document.getElementById('end').value = '100';
                updateCharts();
            }

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                scales: { x: { title: { display: true, text: 't' } } },
                animation: false,
                onClick: (e) => {
                    const chart = e.chart;
                    const points = chart.getElementsAtEventForMode(
                        e,
                        'nearest',
                        { intersect: false },
                        true
                    );
                    if (points.length) {
                        const xValue = chart.scales.x.getValueForPixel(e.x);
                        zoomTo(xValue);
                    }
                },
            };

            async function updateCharts() {
                const r = document.getElementById('real').value;
                const start = document.getElementById('start').value;
                const end = document.getElementById('end').value;
                const q = document.getElementById('mod').value;
                const idx = document.getElementById('char-select').value || 1;
                const steps = 200;

                const loader = document.getElementById('loading-sign');
                if (loader) loader.style.display = 'block';

                try {
                    const response = await fetch(
                        `/scan?r=${r}&start=${start}&end=${end}&q=${q}&idx=${idx}&steps=${steps}`
                    );
                    const data = await response.json();

                    if (data.error) {
                        console.error(data.error);
                        return;
                    }

                    const points = data.points;
                    const labels = points.map((p) => p.t.toFixed(4));
                    const realData = points.map((p) => p.real);
                    const imagData = points.map((p) => p.imag);

                    if (chartReal) chartReal.destroy();
                    chartReal = new Chart(document.getElementById('realChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Re(L(s))',
                                    data: realData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                },
                            ],
                        },
                        options: commonOptions,
                    });

                    if (chartImag) chartImag.destroy();
                    chartImag = new Chart(document.getElementById('imagChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Im(L(s))',
                                    data: imagData,
                                    borderColor: 'rgb(54, 162, 235)',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                },
                            ],
                        },
                        options: commonOptions,
                    });

                    if (chartComplex) chartComplex.destroy();
                    chartComplex = new Chart(document.getElementById('complexChart'), {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [
                                {
                                    label: 'Re',
                                    data: realData,
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                },
                                {
                                    label: 'Im',
                                    data: imagData,
                                    borderColor: 'rgb(54, 162, 235)',
                                    borderWidth: 2,
                                    pointRadius: 0,
                                },
                            ],
                        },
                        options: commonOptions,
                    });
                } catch (error) {
                    console.error('Error computing:', error);
                } finally {
                    if (loader) loader.style.display = 'none';
                }
            }

            // 4. INITIALIZATION
            document.addEventListener('DOMContentLoaded', onModulusChange);

            // 5. KEYBOARD HANDLERS
            document.addEventListener('keydown', function (event) {
                const modInput = document.getElementById('mod');
                const endInput = document.getElementById('end');

                const active = document.activeElement;
                if (active.tagName === 'INPUT' && active !== modInput && active !== endInput) {
                    return;
                }

                if (event.key === 'Escape') {
                    resetZoom();
                    event.preventDefault();
                }

                if (event.key === 'ArrowUp') {
                    modInput.stepUp();
                    onModulusChange();
                    event.preventDefault();
                }
                if (event.key === 'ArrowDown') {
                    modInput.stepDown();
                    onModulusChange();
                    event.preventDefault();
                }

                if (event.key === 'ArrowRight') {
                    endInput.stepUp();
                    updateCharts();
                    event.preventDefault();
                }
                if (event.key === 'ArrowLeft') {
                    endInput.stepDown();
                    updateCharts();
                    event.preventDefault();
                }
            });
        </script>
    </body>
</html>
